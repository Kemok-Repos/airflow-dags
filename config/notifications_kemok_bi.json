{"1": {"message": "Notificacion", "tasks": [{"task_id": "Notificacion a Usuarios Sr Tendero", "type": "Kontact", "address": "7", "message_template": null, "query_template": null, "params": {"kontact_key": "2efbc42c9f6311ea8c9b58fb844606cc"}}], "branching_query": null}, "2": {"message": "Notificacion de fallo y errores", "tasks": [{"task_id": "Notificacion de fallo y errores a Soporte", "type": "Telegram", "address": "674350416", "message_template": "<b>\ud83d\udea8  {{ dag_id }} \ud83d\udea8</b>\n<b>{{ n_errores }} errores encontrados en proceso: </b>\n{% for item in errors %}\n<code> {{item.task_id}} </code>\n{% endfor %}\n\nRealizar un diagnostico <a href=\"https://airflow.kemok.io/graph?dag_id={{ dag_id }}\">aqu\u00ed</a>.", "query_template": "WITH base AS (\nSELECT \n\tjsonb_build_object('task_id', task_id) AS errors\nFROM dag_run_error\nWHERE notified_at IS NULL\n\tAND dag_id = '{dag_id}'\n)\nSELECT \n\tjsonb_build_object('n_errores', COUNT(*), 'errors', array_agg(errors)) AS params\nFROM base\nHAVING COUNT(*) > 0\nLIMIT 1;", "params": null}], "branching_query": "SELECT DISTINCT\n\tdag_notification_tasks.task_id||' a '||dag_addresses.name AS task_id\nFROM dag_run_error\nJOIN dag_notification_tasks ON True\nJOIN dag_notification_addresses ON dag_notification_tasks.id = dag_notification_addresses.id_task\nJOIN dag_addresses ON dag_notification_addresses.id_address = dag_addresses.id\nWHERE dag_notification_tasks.id = 2 AND dag_id = '{dag_id}'\n\tAND dag_run_error.notified_at IS NULL;"}, "3": {"message": "Notificacion de fallo", "tasks": [{"task_id": "Notificacion de fallo a Grupo Telegram", "type": "Telegram", "address": "674350416", "message_template": "<b> \u26a0\ufe0f Proceso finalizado con errores \u26a0\ufe0f </b>\nNuestro equipo ya fue notificado de los {{ n_errores }} errores encontrados.", "query_template": "WITH base AS (\nSELECT \n\tjsonb_build_object('task_id', task_id) AS errors\nFROM dag_run_error\nWHERE notified_at IS NULL\n\tAND dag_id = '{dag_id}'\n)\nSELECT \n\tjsonb_build_object('n_errores', COUNT(*), 'errors', array_agg(errors)) AS params\nFROM base\nHAVING COUNT(*) > 0\nLIMIT 1;", "params": null}], "branching_query": "SELECT DISTINCT\n\tdag_notification_tasks.task_id||' a '||dag_addresses.name AS task_id\nFROM dag_run_error\nJOIN dag_notification_tasks ON True\nJOIN dag_notification_addresses ON dag_notification_tasks.id = dag_notification_addresses.id_task\nJOIN dag_addresses ON dag_notification_addresses.id_address = dag_addresses.id\nWHERE dag_notification_tasks.id = 3 AND dag_id = '{dag_id}'\n\tAND dag_run_error.notified_at IS NULL;"}, "4": {"message": "Notificacion de correccion", "tasks": [{"task_id": "Notificacion de correccion a Grupo Telegram", "type": "Telegram", "address": "674350416", "message_template": "<b>\ud83d\udd27\ud83d\udc77\ud83c\udffc\u200d\u2640\ufe0f\ud83d\udc4d\ud83c\udffc El proceso de {{ dag_id }} ya fue reparado!</b>\nTus datos estan actualizados. \ud83d\udca1", "query_template": "WITH base AS (\nSELECT \n\tjsonb_build_object('task_id', task_id) AS errors\nFROM dag_run_error\nWHERE dag_id = '{dag_id}'\n)\nSELECT \n\tjsonb_build_object('n_errores', COUNT(*)) AS params\nFROM base\nHAVING COUNT(*) > 0\nLIMIT 1;", "params": null}], "branching_query": "SELECT DISTINCT\n\tdag_notification_tasks.task_id||' a '||dag_addresses.name AS task_id\nFROM dag_run_error\nJOIN dag_notification_tasks ON True\nJOIN dag_notification_addresses ON dag_notification_tasks.id = dag_notification_addresses.id_task\nJOIN dag_addresses ON dag_notification_addresses.id_address = dag_addresses.id\nWHERE dag_notification_tasks.id = 4 AND dag_id = '{dag_id}';"}, "5": {"message": "Alerta de inactividad", "tasks": [{"task_id": "Alerta de inactividad a Ana Cristina Villatoro Corado", "type": "Telegram", "address": "1220358595", "message_template": "<b>\ud83d\udea8 Alerta: \ud83d\udea8</b> \n{{ colaborador }} has tenido {{ tiempo }} minutos de inactividad desde las {{ hora }}.", "query_template": "SELECT \n\tjsonb_build_object('colaborador', colaborador, 'tiempo', tiempo, 'hora', hora)\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 5\nLIMIT 1;", "params": {"id_colaborador": 12}}, {"task_id": "Alerta de inactividad a Andr\u00e9s Echeverr\u00eda", "type": "Telegram", "address": "85974318", "message_template": "<b>\ud83d\udea8 Alerta: \ud83d\udea8</b> \n{{ colaborador }} has tenido {{ tiempo }} minutos de inactividad desde las {{ hora }}.", "query_template": "SELECT \n\tjsonb_build_object('colaborador', colaborador, 'tiempo', tiempo, 'hora', hora)\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 5\nLIMIT 1;", "params": {"id_colaborador": 2}}, {"task_id": "Alerta de inactividad a Christian Briceno", "type": "Telegram", "address": "674350416", "message_template": "<b>\ud83d\udea8 Alerta: \ud83d\udea8</b> \n{{ colaborador }} has tenido {{ tiempo }} minutos de inactividad desde las {{ hora }}.", "query_template": "SELECT \n\tjsonb_build_object('colaborador', colaborador, 'tiempo', tiempo, 'hora', hora)\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 5\nLIMIT 1;", "params": {"id_colaborador": 4}}, {"task_id": "Alerta de inactividad a Diego Leal", "type": "Telegram", "address": "331639593", "message_template": "<b>\ud83d\udea8 Alerta: \ud83d\udea8</b> \n{{ colaborador }} has tenido {{ tiempo }} minutos de inactividad desde las {{ hora }}.", "query_template": "SELECT \n\tjsonb_build_object('colaborador', colaborador, 'tiempo', tiempo, 'hora', hora)\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 5\nLIMIT 1;", "params": {"id_colaborador": 6}}, {"task_id": "Alerta de inactividad a Diego Yalibat", "type": "Telegram", "address": "866274156", "message_template": "<b>\ud83d\udea8 Alerta: \ud83d\udea8</b> \n{{ colaborador }} has tenido {{ tiempo }} minutos de inactividad desde las {{ hora }}.", "query_template": "SELECT \n\tjsonb_build_object('colaborador', colaborador, 'tiempo', tiempo, 'hora', hora)\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 5\nLIMIT 1;", "params": {"id_colaborador": 7}}, {"task_id": "Alerta de inactividad a Emilianni Fuentes", "type": "Telegram", "address": "954607108", "message_template": "<b>\ud83d\udea8 Alerta: \ud83d\udea8</b> \n{{ colaborador }} has tenido {{ tiempo }} minutos de inactividad desde las {{ hora }}.", "query_template": "SELECT \n\tjsonb_build_object('colaborador', colaborador, 'tiempo', tiempo, 'hora', hora)\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 5\nLIMIT 1;", "params": {"id_colaborador": 8}}, {"task_id": "Alerta de inactividad a Felix Antonio Marquez Nu\u00f1ez", "type": "Telegram", "address": "674350416", "message_template": "<b>\ud83d\udea8 Alerta: \ud83d\udea8</b> \n{{ colaborador }} has tenido {{ tiempo }} minutos de inactividad desde las {{ hora }}.", "query_template": "SELECT \n\tjsonb_build_object('colaborador', colaborador, 'tiempo', tiempo, 'hora', hora)\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 5\nLIMIT 1;", "params": {"id_colaborador": 9}}, {"task_id": "Alerta de inactividad a Helio L\u00f3pez", "type": "Telegram", "address": "674350416", "message_template": "<b>\ud83d\udea8 Alerta: \ud83d\udea8</b> \n{{ colaborador }} has tenido {{ tiempo }} minutos de inactividad desde las {{ hora }}.", "query_template": "SELECT \n\tjsonb_build_object('colaborador', colaborador, 'tiempo', tiempo, 'hora', hora)\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 5\nLIMIT 1;", "params": {"id_colaborador": 11}}, {"task_id": "Alerta de inactividad a Kevin Mazariegos", "type": "Telegram", "address": "674350416", "message_template": "<b>\ud83d\udea8 Alerta: \ud83d\udea8</b> \n{{ colaborador }} has tenido {{ tiempo }} minutos de inactividad desde las {{ hora }}.", "query_template": "SELECT \n\tjsonb_build_object('colaborador', colaborador, 'tiempo', tiempo, 'hora', hora)\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 5\nLIMIT 1;", "params": {"id_colaborador": 14}}, {"task_id": "Alerta de inactividad a Luis G\u00e1mez", "type": "Telegram", "address": "483050096", "message_template": "<b>\ud83d\udea8 Alerta: \ud83d\udea8</b> \n{{ colaborador }} has tenido {{ tiempo }} minutos de inactividad desde las {{ hora }}.", "query_template": "SELECT \n\tjsonb_build_object('colaborador', colaborador, 'tiempo', tiempo, 'hora', hora)\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 5\nLIMIT 1;", "params": {"id_colaborador": 16}}, {"task_id": "Alerta de inactividad a Madelin Martinez", "type": "Telegram", "address": "1270024312", "message_template": "<b>\ud83d\udea8 Alerta: \ud83d\udea8</b> \n{{ colaborador }} has tenido {{ tiempo }} minutos de inactividad desde las {{ hora }}.", "query_template": "SELECT \n\tjsonb_build_object('colaborador', colaborador, 'tiempo', tiempo, 'hora', hora)\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 5\nLIMIT 1;", "params": {"id_colaborador": 17}}, {"task_id": "Alerta de inactividad a Sa\u00fal Hern\u00e1ndez", "type": "Telegram", "address": "674350416", "message_template": "<b>\ud83d\udea8 Alerta: \ud83d\udea8</b> \n{{ colaborador }} has tenido {{ tiempo }} minutos de inactividad desde las {{ hora }}.", "query_template": "SELECT \n\tjsonb_build_object('colaborador', colaborador, 'tiempo', tiempo, 'hora', hora)\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 5\nLIMIT 1;", "params": {"id_colaborador": 20}}, {"task_id": "Alerta de inactividad a Wilmer Fermin", "type": "Telegram", "address": "674350416", "message_template": "<b>\ud83d\udea8 Alerta: \ud83d\udea8</b> \n{{ colaborador }} has tenido {{ tiempo }} minutos de inactividad desde las {{ hora }}.", "query_template": "SELECT \n\tjsonb_build_object('colaborador', colaborador, 'tiempo', tiempo, 'hora', hora)\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 5\nLIMIT 1;", "params": {"id_colaborador": 22}}, {"task_id": "Alerta de inactividad a Yesther Guerra", "type": "Telegram", "address": "674350416", "message_template": "<b>\ud83d\udea8 Alerta: \ud83d\udea8</b> \n{{ colaborador }} has tenido {{ tiempo }} minutos de inactividad desde las {{ hora }}.", "query_template": "SELECT \n\tjsonb_build_object('colaborador', colaborador, 'tiempo', tiempo, 'hora', hora)\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 5\nLIMIT 1;", "params": {"id_colaborador": 5}}], "branching_query": "SELECT DISTINCT\n\tdag_notification_tasks.task_id||' a '||dag_addresses.name AS task_id\nFROM vista_inactividad_reciente\nJOIN dag_notification_tasks ON vista_inactividad_reciente.message_id = dag_notification_tasks.id\nJOIN dag_addresses ON vista_inactividad_reciente.id::text = dag_addresses.params->>'id_colaborador'\nWHERE vista_inactividad_reciente.message_id = {message_id};"}, "6": {"message": "Alerta de colaborador a cargo con inactividad", "tasks": [{"task_id": "Alerta de colaborador a cargo con inactividad a Ana Cristina Villatoro Corado", "type": "Telegram", "address": "1220358595", "message_template": "<b>\ud83d\udea8  Ojo: \ud83d\udea8</b>\n{% for item in alertas %}\n{{ item.colaborador }} ha tenido {{ item.tiempo }} minutos de inactividad desde las {{ item.hora }}.\n{% endfor %}", "query_template": "SELECT \njsonb_build_object('alertas', jsonb_agg(('{{\"colaborador\" : \"'||colaborador||'\", \"tiempo\" : \"'||tiempo||'\", \"hora\" : \"'||hora||'\"}}')::jsonb)) AS params\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 6\nHAVING jsonb_agg(('{{\"colaborador\" : \"'||colaborador||'\", \"tiempo\" : \"'||tiempo||'\", \"hora\" : \"'||hora||'\"}}')::jsonb) IS NOT NULL;", "params": {"id_colaborador": 12}}, {"task_id": "Alerta de colaborador a cargo con inactividad a Diego Leal", "type": "Telegram", "address": "331639593", "message_template": "<b>\ud83d\udea8  Ojo: \ud83d\udea8</b>\n{% for item in alertas %}\n{{ item.colaborador }} ha tenido {{ item.tiempo }} minutos de inactividad desde las {{ item.hora }}.\n{% endfor %}", "query_template": "SELECT \njsonb_build_object('alertas', jsonb_agg(('{{\"colaborador\" : \"'||colaborador||'\", \"tiempo\" : \"'||tiempo||'\", \"hora\" : \"'||hora||'\"}}')::jsonb)) AS params\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 6\nHAVING jsonb_agg(('{{\"colaborador\" : \"'||colaborador||'\", \"tiempo\" : \"'||tiempo||'\", \"hora\" : \"'||hora||'\"}}')::jsonb) IS NOT NULL;", "params": {"id_colaborador": 6}}, {"task_id": "Alerta de colaborador a cargo con inactividad a Kevin Mazariegos", "type": "Telegram", "address": "674350416", "message_template": "<b>\ud83d\udea8  Ojo: \ud83d\udea8</b>\n{% for item in alertas %}\n{{ item.colaborador }} ha tenido {{ item.tiempo }} minutos de inactividad desde las {{ item.hora }}.\n{% endfor %}", "query_template": "SELECT \njsonb_build_object('alertas', jsonb_agg(('{{\"colaborador\" : \"'||colaborador||'\", \"tiempo\" : \"'||tiempo||'\", \"hora\" : \"'||hora||'\"}}')::jsonb)) AS params\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 6\nHAVING jsonb_agg(('{{\"colaborador\" : \"'||colaborador||'\", \"tiempo\" : \"'||tiempo||'\", \"hora\" : \"'||hora||'\"}}')::jsonb) IS NOT NULL;", "params": {"id_colaborador": 14}}, {"task_id": "Alerta de colaborador a cargo con inactividad a Luis G\u00e1mez", "type": "Telegram", "address": "483050096", "message_template": "<b>\ud83d\udea8  Ojo: \ud83d\udea8</b>\n{% for item in alertas %}\n{{ item.colaborador }} ha tenido {{ item.tiempo }} minutos de inactividad desde las {{ item.hora }}.\n{% endfor %}", "query_template": "SELECT \njsonb_build_object('alertas', jsonb_agg(('{{\"colaborador\" : \"'||colaborador||'\", \"tiempo\" : \"'||tiempo||'\", \"hora\" : \"'||hora||'\"}}')::jsonb)) AS params\nFROM vista_inactividad_reciente\nWHERE id = {id_colaborador} AND message_id = 6\nHAVING jsonb_agg(('{{\"colaborador\" : \"'||colaborador||'\", \"tiempo\" : \"'||tiempo||'\", \"hora\" : \"'||hora||'\"}}')::jsonb) IS NOT NULL;", "params": {"id_colaborador": 16}}], "branching_query": "SELECT DISTINCT\n\tdag_notification_tasks.task_id||' a '||dag_addresses.name AS task_id\nFROM vista_inactividad_reciente\nJOIN dag_notification_tasks ON vista_inactividad_reciente.message_id = dag_notification_tasks.id\nJOIN dag_addresses ON vista_inactividad_reciente.id::text = dag_addresses.params->>'id_colaborador'\nWHERE vista_inactividad_reciente.message_id = {message_id};"}}